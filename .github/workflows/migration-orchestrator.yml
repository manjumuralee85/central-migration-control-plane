name: Migration Orchestrator

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Operation mode"
        required: true
        default: "direct_migrate"
        type: choice
        options:
          - direct_migrate
          - sync_templates
          - trigger_migration
      target_repo:
        description: "Optional single repo (owner/name). Leave blank for all enabled repos"
        required: false
        type: string
      spring_boot_version:
        description: "Spring Boot version for trigger_migration"
        required: false
        default: "3.3.6"
        type: choice
        options:
          - "2.7.18"
          - "3.2.12"
          - "3.3.6"
          - "3.4.2"
      target_java_version:
        description: "Target Java version for migration recipe generation"
        required: false
        default: "21"
        type: choice
        options:
          - "11"
          - "17"
          - "21"

jobs:
  build-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Checkout control plane repo
        uses: actions/checkout@v4

      - name: Build repository matrix from config
        id: matrix
        run: |
          set -euo pipefail
          TARGET_REPO='${{ github.event.inputs.target_repo }}'
          MATRIX_JSON=$(./scripts/select-repos.sh ./config/repos.json "$TARGET_REPO")
          echo "matrix=$MATRIX_JSON" >> "$GITHUB_OUTPUT"
          echo "$MATRIX_JSON"

  run:
    needs: build-matrix
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.build-matrix.outputs.matrix).include[0] != null }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}

    steps:
      - name: Checkout control plane repo
        uses: actions/checkout@v4

      - name: Validate target repository access
        if: ${{ github.event.inputs.mode == 'direct_migrate' }}
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_BOT_TOKEN }}
        run: |
          set -euo pipefail
          REPO='${{ matrix.repo }}'
          if ! gh api "/repos/${REPO}" >/tmp/repo-access.json 2>/tmp/repo-access.err; then
            echo "Failed to access ${REPO} with MIGRATION_BOT_TOKEN."
            cat /tmp/repo-access.err || true
            echo "Ensure the token has repository access (contents:read at minimum, and write for PR branch push)."
            exit 1
          fi
          CAN_PUSH=$(jq -r '.permissions.push // false' /tmp/repo-access.json)
          CAN_PULL=$(jq -r '.permissions.pull // false' /tmp/repo-access.json)
          if [[ "$CAN_PULL" != "true" ]]; then
            echo "Token cannot read ${REPO} (permissions.pull=false)."
            exit 1
          fi
          if [[ "$CAN_PUSH" != "true" ]]; then
            echo "Token can read ${REPO} but cannot push (permissions.push=false)."
            echo "Direct migration PR creation requires write access to target repo."
            exit 1
          fi

      - name: Checkout target repository
        if: ${{ github.event.inputs.mode == 'direct_migrate' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          ref: ${{ matrix.default_branch }}
          token: ${{ secrets.MIGRATION_BOT_TOKEN }}
          path: target-repo

      - name: Set up JDK for direct migration
        if: ${{ github.event.inputs.mode == 'direct_migrate' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ github.event.inputs.target_java_version || matrix.java_version || '21' }}
          cache: maven

      - name: Apply centralized migration directly in target repository
        id: direct_migrate
        if: ${{ github.event.inputs.mode == 'direct_migrate' }}
        run: |
          set -euo pipefail
          TARGET_JAVA='${{ github.event.inputs.target_java_version || matrix.java_version || '21' }}'
          TARGET_BOOT='${{ github.event.inputs.spring_boot_version || matrix.spring_boot_version }}'
          if [[ "$TARGET_JAVA" -le 11 && "$TARGET_BOOT" =~ ^3\. ]]; then
            TARGET_BOOT='${{ matrix.spring_boot_version || '2.7.18' }}'
          fi
          PROFILE='${{ matrix.migration_profile }}'
          if [[ -z "$PROFILE" || "$PROFILE" == "null" ]]; then
            PROFILE=$(./scripts/detect-profile.sh target-repo)
          fi
          if [[ "$PROFILE" == "unsupported" ]]; then
            echo "No supported migration profile detected for ${{ matrix.repo }}. Set migration_profile explicitly."
            exit 1
          fi
          echo "profile_used=$PROFILE" >> "$GITHUB_OUTPUT"
          mkdir -p target-repo/.github/rewrite
          ./scripts/analyze-repo.sh target-repo > target-repo/.github/rewrite/analysis.json
          ./scripts/generate-recipe.sh \
            target-repo/.github/rewrite/analysis.json \
            "$TARGET_BOOT" \
            "$TARGET_JAVA" \
            target-repo/.github/rewrite/migration-recipe.yml
          ./scripts/generate-upgrade-report.sh \
            target-repo/.github/rewrite/analysis.json \
            "$TARGET_BOOT" \
            "$TARGET_JAVA" \
            target-repo/.github/rewrite/dependency-upgrade-report.md
          ./scripts/migrate-repo.sh \
            target-repo \
            "$PROFILE" \
            "$TARGET_BOOT" \
            "$GITHUB_WORKSPACE" \
            "target-repo/.github/rewrite/analysis.json"

      - name: Upload dependency analysis artifact
        if: ${{ github.event.inputs.mode == 'direct_migrate' }}
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis-${{ github.run_id }}-${{ strategy.job-index }}
          path: |
            target-repo/.github/rewrite/analysis.json
            target-repo/.github/rewrite/dependency-upgrade-report.md
          retention-days: 14

      - name: Ensure generated build artifacts are not committed
        if: ${{ github.event.inputs.mode == 'direct_migrate' }}
        run: |
          set -euo pipefail
          # Revert any tracked build outputs and workflow noise in the target repo.
          git -C target-repo restore --source=HEAD --worktree --staged -- target || true
          git -C target-repo restore --source=HEAD --worktree --staged -- .rewrite || true
          git -C target-repo restore --source=HEAD --worktree --staged -- .github/workflows || true

          # Remove transient generated files that should never be part of PRs.
          rm -rf target-repo/target target-repo/.rewrite
          git -C target-repo clean -fd -- target .rewrite || true
          rm -f target-repo/.github/rewrite/analysis.json
          rm -f target-repo/.github/rewrite/dependency-upgrade-report.md
          find target-repo -type f -name "*.class" -delete

      - name: Create migration PR with code changes
        if: ${{ github.event.inputs.mode == 'direct_migrate' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MIGRATION_BOT_TOKEN }}
          path: target-repo
          commit-message: |
            chore: centralized Java migration + dependency modernization

            - Applied centralized migration profile: ${{ steps.direct_migrate.outputs.profile_used }}
            - Analyzed current Java/framework/dependency versions
            - Applied generated OpenRewrite migration recipes
            - Ran build + tests
          branch: "migration/direct-${{ github.run_id }}"
          delete-branch: true
          title: "Centralized migration: Java ${{ github.event.inputs.target_java_version || matrix.java_version || '21' }} + Spring Boot"
          body: |
            This PR was generated by the centralized migration control plane.

            Applied profile: `${{ steps.direct_migrate.outputs.profile_used }}`
            Target Java version: `${{ github.event.inputs.target_java_version || matrix.java_version || '21' }}`
            Target Spring Boot version: `${{ github.event.inputs.spring_boot_version || matrix.spring_boot_version }}`

            Includes code and build descriptor updates from OpenRewrite and profile patches.
            Build/test checks executed during migration run.
            Dependency analysis report is attached as workflow artifact.
          labels: |
            migration
            automation
            java-migration
            spring-boot
          add-paths: |
            pom.xml
            src/main/**
            src/test/**

      - name: Sync migration templates to target repository
        if: ${{ github.event.inputs.mode == 'sync_templates' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repo }}
          ref: ${{ matrix.default_branch }}
          token: ${{ secrets.MIGRATION_BOT_TOKEN }}
          path: target-repo

      - name: Copy migration workflow and recipe config
        if: ${{ github.event.inputs.mode == 'sync_templates' }}
        run: |
          set -euo pipefail
          mkdir -p target-repo/.github/workflows
          mkdir -p target-repo/.github/rewrite
          cp ./templates/convert-to-spring-boot.yml target-repo/.github/workflows/convert-to-spring-boot.yml
          cp ./templates/migration-recipe.yml target-repo/.github/rewrite/migration-recipe.yml

      - name: Create pull request to sync migration templates
        if: ${{ github.event.inputs.mode == 'sync_templates' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.MIGRATION_BOT_TOKEN }}
          path: target-repo
          commit-message: "chore: sync centralized migration workflow templates"
          branch: "migration/sync-template-${{ github.run_id }}"
          delete-branch: true
          title: "Sync centralized Java 21 + Spring Boot migration templates"
          body: |
            Automated sync from centralized migration control plane.

            Included:
            - `.github/workflows/convert-to-spring-boot.yml`
            - `.github/rewrite/migration-recipe.yml`

            Next: Run `Convert to Spring Boot` workflow in this repo.
          labels: |
            migration
            automation

      - name: Trigger migration workflow in target repository
        if: ${{ github.event.inputs.mode == 'trigger_migration' }}
        env:
          GH_TOKEN: ${{ secrets.MIGRATION_BOT_TOKEN }}
        run: |
          set -euo pipefail
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ matrix.repo }}/actions/workflows/convert-to-spring-boot.yml/dispatches" \
            -f ref='${{ matrix.default_branch }}' \
            -f inputs[spring_boot_version]='${{ github.event.inputs.spring_boot_version || matrix.spring_boot_version }}'
          echo "Triggered convert-to-spring-boot.yml in ${{ matrix.repo }}"
